<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Hello World -- jquery.template.js</title>
		<script src="https://unpkg.com/jquery"></script>
		<script src="https://unpkg.com/jquery-hashchange@2.0.0/jquery.ba-hashchange.js"></script>
	</head>
	<body>
		<script>
			$(function(){
				$(window).bind('hashchange', hashChangeFire)
			})

			function hashChangeFire(){
				var page = getHashPage()
				if(page === null) return
				renderPage(page)
			}

			function getHashPage(){
				var hash = window.location.hash,
					matchs = hash.match(/^(#!\/)([a-zA-Z0-9-_]+)?$/)
				return matchs ? '/' + (matchs[2] || '') : matchs
			}

			var el, routers
			function renderPage(){
				if(arguments.length == 2){
					el = arguments[0]
					routers = arguments[1]
				}
				var page = arguments.length == 2 ? (getHashPage() || '/') : arguments[0]
				render(el, routers[page])
			}

			function createElement(name){
				return $(document.createElement(name));
			}

			function isComponent(element){
				return element.hasOwnProperty('view')
			}

			function render(el, element){
				$(el).empty().append(compileComponent(element))
			}

			function compileComponent(element){
				if(! (element instanceof Array)) element = [element]
				var elements = []
				for(var i in element){
					if(isComponent(element[i])){
						components = element[i].view()
						if(components instanceof Array) elements = elements.concat(compileComponent(components))
						else elements.push(compileElement(components))
					}else{
						elements.push(compileElement(element[i]))
					}
				}
				return elements
			}

			function compileElement(element){
				var el = element.el,
					events = element.events || {},
					childers = element.childers || []
				for(var event in events) {
					$(el).on(event, events[event])
				}
				childers = compileComponent(childers)
				return el.append(childers)
			}
			
			const HelloWord = {
				view: function(){
					return [
						{
							el: createElement('span').attr({class: 'hello-word'}).text('hello word'),
							events: {
								click: function(){
									alert('hello word')
								}
							}
						},
						{
							el: createElement('a').attr('href', '#!/'),
							childers: [
								{
									el: createElement('span').text('点我返回')
								}
							]
						}
					]
				}
			}

			const Main = {
				view: function(){
					return [
						{
							el: createElement('h1').attr({class: 'title'}),
							events: {
								click: function(){
									alert('请点击hello word哦')
								}
							},
							childers: [
								{
									el: createElement('span').text('jquery.template.js')
								}
							]
						},
						HelloWord,
						{
							el: createElement('div'),
							childers: [
								{
									el: createElement('span').text('作者邮箱: overbob@yeah.net'),
									events: {
										click: function(){
											alert('请邮件联系我')
										}
									}
								}
							]
						},
						{
							el: createElement('a').attr('href', '#!/hello'),
							childers: [
								{
									el: createElement('span').text('点我跳转')
								}
							]
						}
					]
				}
			}

			renderPage('body', {
				'/': Main,
				'/hello': HelloWord
			})
		</script>
	</body>
</html>